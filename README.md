# eNPSBot

Телеграм-мини-приложение для сбора еженедельного внутреннего NPS в проектных командах Металампа. Сервис позволяет сотрудникам отвечать на стандартизированную анкету, автоматически сохраняет каждый ответ и дает возможность анализировать историю по каждому проекту.

## Возможности

- авторизация сотрудников через Telegram Web App (init data);
- единый каталог проектов с поиском и быстрым добавлением новых записей;
- пошаговая анкета из 10 вопросов c автоматическим сохранением после каждого ответа;
- история отправленных форм с пометкой о доступности редактирования в течение 24 часов;
- дизайн в фирменном стиле Металампа, адаптивный интерфейс для мобильных устройств.

## Технологии

- **Backend:** Node.js, Express, SQLite (better-sqlite3), TypeScript;
- **Frontend:** React + Vite + TypeScript, Telegram Web Apps API;
- **Валидация:** Zod;
- **Стили:** кастомные компоненты, CSS без дополнительных библиотек.

## Архитектура

- `src/lib` — инфраструктурные сервисы (инициализация SQLite, общие утилиты);
- `src/features/*` — модули доменных областей (`projects`, `surveys`, `users`, `feature-flags`) c репозиториями, сервисами и роутерами;
- `client/src/app` — корневой слой приложения (инициализация Telegram, фич-флаги, компоновка экрана);
- `client/src/features/*` — изолированные функциональные блоки фронтенда (проекты, анкеты, история);
- `client/src/shared` — переиспользуемые типы, API-клиент и хуки.

## Подготовка окружения

1. Склонируйте репозиторий и установите зависимости проекта:

   ```bash
   npm install
   cd client && npm install && cd ..
   ```

2. Настройте переменные окружения (см. `.env.example`). Минимально необходим токен бота Telegram для валидации `initData`:

   ```bash
   cp .env.example .env
   # отредактируйте BOT_TOKEN и при необходимости остальные параметры
   ```

   Для локальной разработки без Telegram можно задать `ALLOW_INSECURE_INIT_DATA=true` и передавать фиктивного пользователя через заголовок `x-debug-user`. Дополнительно переменная `FEATURE_FLAGS` позволяет включать/отключать функциональные блоки без перекомпиляции (см. раздел ниже).

3. Примените миграции (создание таблиц происходит автоматически при первом запуске).

## Локальный запуск

Запустите API и фронтенд в отдельных терминалах:

```bash
# терминал 1 — backend
npm run dev

# терминал 2 — frontend
npm run client:dev
```

Vite настроен на проксирование запросов `/api` на `http://localhost:3000`, поэтому интерфейс будет доступен на `http://localhost:5173`.

### Сборка продакшн-версии

```bash
npm run build            # компиляция сервера и сборка фронтенда в client/dist
npm start                # запуск Express, который раздает статический бандл
```

Express автоматически обслуживает собранный фронтенд из каталога `client/dist`. Если нужно собрать только серверную часть, выполните `npm run build:server`.

## Фича-флаги

Система поддерживает включение/выключение функций через переменную окружения `FEATURE_FLAGS` (значения `true/false`, перечисляются через запятую). Доступные флаги:

- `analyticsDashboard` — отображение агрегированных метрик в истории ответов;
- `projectCreation` — возможность создавать новые проекты с клиентской стороны;
- `responseEditing` — разрешение редактировать ответы в течение 24 часов.

Пример: `FEATURE_FLAGS=analyticsDashboard=true,projectCreation=false,responseEditing=true`.

## Структура БД

- `users` — сотрудники Telegram, прошедшие авторизацию;
- `projects` — список проектов компании;
- `surveys` — ответы на анкету, уникальные по пользователю, проекту и дате.

Ответы сохраняются сразу после каждого вопроса, а редактирование возможно в течение 24 часов с момента создания записи.

Файл базы данных по умолчанию размещается в `data/enps.sqlite` (путь можно изменить через `DATABASE_FILE`). Он хранится отдельно от собранных файлов, поэтому данные не теряются при перезапусках сервера или горячей перезагрузке во время разработки.

## Тесты и проверки

Перед отправкой изменений выполните:

```bash
npm run lint          # проверка TypeScript для backend
npm run client:lint   # ESLint + TypeScript для фронтенда
npm run build         # полный билд сервера и фронтенда
```

## Лицензия

Проект распространяется под лицензией ISC.
